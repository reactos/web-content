---
title:       "At the peak of the mountain... there's a hill?"
author:      "gigaherz"
date:        2014-04-15
aliases:     [ "/node/816" ]
---

<p>This week really didn’t “start”; it was merely a continuation of the past weeks.</p>
<p>The issue where the toolbar did not receive clicks was one of those annoying problems where finding the apparent cause is easy, but finding a solution not so much. The issue, as far as I could tell, was related to using SetCapture as a means to track the mouse movement on top of the toolbar. If I disabled that piece of code, the clicks got through, but – of course – other features stopped working.</p>
<p>I messed around for a while, aimlessly, until I got a simple idea: wouldn’t the toolbar use the existing TrackMouseEvent feature as a means to decide when the mouse moves away from its rectangle? If so, it would mean the toolbar would receive a WM_MOUSELEAVE event, which I could use instead of the captures. Lucky for me, it worked!</p>
<p>There were some details to fix still, and I had to test that it worked in all the platforms, and in fact, some of those details still remain today, but the basic and essential mouse interactions as well as they can be expected to work.</p>
<p align="center">
<img alt="Happy Cat" src="/img/blogs/gigaherz/happy-smiling-cat.jpg" style="width: 429px; height: 500px;">
(Source: <a href="http://upload.wikimedia.org/wikipedia/commons/thumb/0/04/So_happy_smiling_cat.jpg/658px-So_happy_smiling_cat.jpg" target="_blank">upload.wikimedia.org</a>)
</p>
<p>After this long-awaited success, I took a step back and decided to revise the code, comment some more functions, and test previously-working features known bugs, to see if anything changed. Of course, something had to fail, otherwise my work may be easy to do.</p>
<p>While testing, I noticed the context menus weren’t working correctly. I fixed it somewhat, but a very strange issue remains. When I right-click on certain items, I get the following exception:</p>
<pre style="margin-left: 36pt;">First-chance exception at {address} in explorer.exe: 0xC0000008: An invalid handle was specified.</pre>
<p>When this happens, the context menu doesn’t get to display, and the call to IContextMenu::QueryContextMenu() never returns. Breaking on the exception points to TortoiseGit being at fault, but it makes me wonder: is it a problem with TortoiseGit, or is it a side-effect of a bug in my code? Given that TGit works fine otherwise, and it worked in the past, I must assume it’s my fault. But I don’t know how to even begin testing this issue.</p>
<p align="center">
<img alt="Hangover Cat" src="/img/blogs/gigaherz/hangover-cat.jpg" height="477" width="638">
(Source: <a href="http://likealady.bg/pictures/i19871_w668.jpg" target="_blank">likealady.bg</a>)
</p>
<p>https://www.reactos.org/forum/viewtopic.php?f=2&amp;t=13226</p>
